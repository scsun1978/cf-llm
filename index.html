<script>
  const API_LOGIN_URL = 'https://floral-hill-cdd0.yamasun001-85b.workers.dev/login'; // 登录接口
  const API_CHAT_URL = 'https://floral-hill-cdd0.yamasun001-85b.workers.dev/'; // 聊天接口

  const authContainer = document.getElementById('auth-container');
  const chatContainer = document.getElementById('chat-container');
  const loginButton = document.getElementById('login-button');
  const sendButton = document.getElementById('send-button');
  const chatBox = document.getElementById('chat-box');
  const messageInput = document.getElementById('message-input');

  let apiKey = null;

  // 显示登录界面
  authContainer.style.display = 'flex';

  // 登录逻辑
  loginButton.addEventListener('click', async () => {
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value.trim();

    if (!username || !password) {
      alert('Please enter both username and password.');
      return;
    }

    try {
      const response = await fetch(API_LOGIN_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password })
      });

      const data = await response.json();

      if (response.status === 200 && data.apiKey) {
        apiKey = data.apiKey; // 保存 apiKey
        authContainer.style.display = 'none';
        chatContainer.style.display = 'flex';
        sendButton.disabled = false;

        appendMessage('Login successful. You can now start chatting.', 'ai');
      } else {
        alert(data.error || 'Login failed.');
      }
    } catch (error) {
      console.error('Login Error:', error);
      alert('Unable to connect to the server.');
    }
  });

  // 添加消息到聊天框
  const appendMessage = (content, className) => {
    const messageDiv = document.createElement('div');
    messageDiv.textContent = content;
    messageDiv.className = `message ${className}`;
    chatBox.appendChild(messageDiv);
    chatBox.scrollTop = chatBox.scrollHeight;
  };

  // 处理流式数据
  const handleStream = async (response) => {
    const reader = response.body.getReader();
    const decoder = new TextDecoder('utf-8');
    let content = '';

    while (true) {
      const { value, done } = await reader.read();
      if (done) break;

      const chunk = decoder.decode(value, { stream: true });
      content += chunk;

      // 更新聊天框
      if (chunk.trim()) {
        const existingAiMessage = chatBox.querySelector('.ai:last-child');
        if (existingAiMessage) {
          existingAiMessage.textContent = content.trim();
        } else {
          appendMessage(content.trim(), 'ai');
        }
      }
    }
  };

  // 发送消息逻辑（支持流式处理）
  sendButton.addEventListener('click', async () => {
    const message = messageInput.value.trim();
    if (!message) return;

    appendMessage(message, 'user');
    messageInput.value = '';
    sendButton.disabled = true;

    try {
      const payload = { type: 'stream', message }; // 设置 type 为 stream
      const response = await fetch(API_CHAT_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${apiKey}`
        },
        body: JSON.stringify(payload)
      });

      if (response.ok) {
        appendMessage('', 'ai'); // 添加一个占位符消息
        await handleStream(response);
      } else {
        const errorData = await response.json();
        appendMessage(`Error: ${errorData.error || 'Unable to connect to AI.'}`, 'ai');
      }
    } catch (error) {
      appendMessage('Error: Unable to connect to AI.', 'ai');
      console.error('Fetch Error:', error);
    } finally {
      sendButton.disabled = false;
    }
  });

  messageInput.addEventListener('keypress', (event) => {
    if (event.key === 'Enter' && !event.shiftKey) {
      event.preventDefault();
      sendButton.click();
    }
  });

  // 自适应输入框高度
  messageInput.addEventListener('input', () => {
    messageInput.style.height = 'auto';
    messageInput.style.height = `${messageInput.scrollHeight}px`;
  });
</script>
